<!-- templates/admin/products/product/delete_confirm.html -->
{% extends '../../base/base.html' %}

{% block title %}حذف محصول - {{ product.title }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'panelAdmin:admin_product_list' %}">محصولات</a></li>
<li class="breadcrumb-item active">حذف {{ product.title }}</li>
{% endblock %}

{% block page_title %}حذف محصول <small class="text-muted">({{ product.title }})</small>{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle"></i> تأیید حذف محصول</h5>
            </div>
            <div class="card-body">
                <!-- هشدار -->
                <div class="alert alert-danger mb-4">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle fa-2x"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">هشدار!</h5>
                            <p class="mb-0">این عملیات غیرقابل بازگشت است</p>
                        </div>
                    </div>
                </div>

                <!-- اطلاعات محصول -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">مشخصات محصول</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                {% if product.mainImage %}
                                <img src="{{ product.mainImage.url }}" alt="{{ product.title }}"
                                     class="img-fluid rounded mb-3" style="max-height: 150px; object-fit: contain;">
                                {% else %}
                                <div class="no-image-medium">
                                    <i class="fas fa-image fa-3x text-muted"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-8">
                                <h4>{{ product.title }}</h4>
                                <code>{{ product.slug }}</code>

                                <div class="row mt-3">
                                    <div class="col-md-6 mb-2">
                                        <strong>برند:</strong><br>
                                        {% if product.brand %}
                                        <span class="badge bg-primary">{{ product.brand.title }}</span>
                                        {% else %}
                                        <span class="text-muted">بدون برند</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>وضعیت:</strong><br>
                                        {% if product.isActive %}
                                        <span class="badge bg-success">فعال</span>
                                        {% else %}
                                        <span class="badge bg-danger">غیرفعال</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>تاریخ ایجاد:</strong><br>
                                        <span class="text-muted">{{ product.createdAt|date:"Y/m/d" }}</span>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>قیمت:</strong><br>
                                        {% with product.saleTypes.first as price %}
                                            {% if price %}
                                                <span class="text-success">{{ price.price|floatformat:0 }} تومان</span>
                                            {% else %}
                                                <span class="text-danger">نامشخص</span>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- آمار و هشدارها -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-chart-bar"></i> آمار مرتبط</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            {% if comment_stats.total_comments > 0 %}
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <div class="h4 text-danger mb-0">{{ comment_stats.total_comments }}</div>
                                    <div class="text-muted">نظر</div>
                                </div>
                            </div>
                            {% endif %}

                            {% if product.galleries.count > 0 %}
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <div class="h4 text-danger mb-0">{{ product.galleries.count }}</div>
                                    <div class="text-muted">تصویر گالری</div>
                                </div>
                            </div>
                            {% endif %}

                            {% if product.saleTypes.count > 0 %}
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <div class="h4 text-danger mb-0">{{ product.saleTypes.count }}</div>
                                    <div class="text-muted">قیمت ثبت شده</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        {% if comment_stats.total_comments > 0 or product.galleries.count > 0 %}
                        <div class="alert alert-warning mt-3">
                            <h6><i class="fas fa-info-circle"></i> توجه:</h6>
                            <ul class="mb-0">
                                {% if comment_stats.total_comments > 0 %}
                                <li>{{ comment_stats.total_comments }} نظر برای این محصول ثبت شده است</li>
                                {% endif %}
                                {% if product.galleries.count > 0 %}
                                <li>{{ product.galleries.count }} تصویر در گالری محصول وجود دارد</li>
                                {% endif %}
                                {% if product.saleTypes.count > 0 %}
                                <li>{{ product.saleTypes.count }} قیمت برای این محصول ثبت شده است</li>
                                {% endif %}
                                <li>با حذف محصول، همه این اطلاعات نیز حذف می‌شوند</li>
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- اطلاعات تکمیلی -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">اطلاعات تکمیلی</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>دسته‌بندی‌ها:</strong><br>
                                {% if product.category.all %}
                                {% for cat in product.category.all %}
                                <span class="badge bg-info">{{ cat.title }}</span>
                                {% endfor %}
                                {% else %}
                                <span class="text-muted">بدون دسته‌بندی</span>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>ویژگی‌ها:</strong><br>
                                {% if product.featuresValue.all %}
                                {% for feature in product.featuresValue.all|slice:":3" %}
                                <small class="d-block">{{ feature.feature.title }}: {{ feature.value }}</small>
                                {% endfor %}
                                {% if product.featuresValue.count > 3 %}
                                <small class="text-muted">+{{ product.featuresValue.count|add:"-3" }} ویژگی دیگر</small>
                                {% endif %}
                                {% else %}
                                <span class="text-muted">بدون ویژگی</span>
                                {% endif %}
                            </div>
                        </div>

                        {% if product.shortDescription %}
                        <div class="mt-3">
                            <strong>توضیح کوتاه:</strong>
                            <p class="text-muted mb-0">{{ product.shortDescription }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- فرم حذف -->
                <form method="post" id="deleteForm">
                    {% csrf_token %}
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'panelAdmin:admin_product_detail' product.id %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-right"></i> بازگشت
                        </a>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> بله، حذف شود
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.card.border-danger {
    border-width: 2px;
    border-color: #dc3545 !important;
}

.no-image-medium {
    width: 150px;
    height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 8px;
    margin: 0 auto;
    border: 2px dashed #dee2e6;
}
</style>

<script>
// تأیید نهایی حذف
document.getElementById('deleteForm').addEventListener('submit', function(e) {
    const commentCount = {{ comment_stats.total_comments|default:0 }};
    const galleryCount = {{ product.galleries.count|default:0 }};
    const saleTypeCount = {{ product.saleTypes.count|default:0 }};

    let message = '⚠️ هشدار نهایی!\n\n';
    message += 'با حذف این محصول:\n';

    if (commentCount > 0) message += `• ${commentCount} نظر حذف می‌شود\n`;
    if (galleryCount > 0) message += `• ${galleryCount} تصویر حذف می‌شود\n`;
    if (saleTypeCount > 0) message += `• ${saleTypeCount} قیمت حذف می‌شود\n`;
    message += '• این عمل غیرقابل بازگشت است\n\n';
    message += 'آیا مطمئن هستید؟';

    if (!confirm(message)) {
        e.preventDefault();
    }
});

// شمارش معکوس برای تایید
let countdown = 5;
const submitBtn = document.querySelector('#deleteForm button[type="submit"]');
const originalText = submitBtn.innerHTML;

function updateButton() {
    if (countdown > 0) {
        submitBtn.innerHTML = `(${countdown}) ${originalText}`;
        submitBtn.disabled = true;
        countdown--;
        setTimeout(updateButton, 1000);
    } else {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}

// فعال‌سازی شمارش معکوس (اختیاری)
// updateButton();
</script>
{% endblock %}