{% extends '../../base/base.html' %}

{% block title %}حذف اسلایدر اصلی - {{ slider.textSlider }}{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'panelAdmin:admin_slider_main_list' %}">اسلایدرهای اصلی</a></li>
<li class="breadcrumb-item active">حذف {{ slider.textSlider|truncatechars:20 }}</li>
{% endblock %}

{% block page_title %}حذف اسلایدر اصلی <small class="text-muted">({{ slider.textSlider }})</small>{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0"><i class="fas fa-exclamation-triangle"></i> تأیید حذف اسلایدر اصلی</h5>
            </div>
            <div class="card-body">
                <!-- هشدار -->
                <div class="alert alert-danger mb-4">
                    <div class="d-flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle fa-2x"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h5 class="alert-heading">هشدار ویژه!</h5>
                            <p class="mb-0">این اسلایدر در <strong>صفحه اصلی سایت</strong> نمایش داده می‌شود. حذف آن ممکن است بر ظاهر سایت تأثیر بگذارد.</p>
                        </div>
                    </div>
                </div>

                <!-- اطلاعات اسلایدر -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0">مشخصات اسلایدر اصلی</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center mb-3">
                                {% if slider.imageName %}
                                <img src="{{ slider.imageName.url }}" alt="{{ slider.altSlide }}"
                                     class="img-fluid rounded mb-3" style="max-height: 150px; object-fit: contain;">
                                {% else %}
                                <div class="no-image-medium">
                                    <i class="fas fa-image fa-3x text-muted"></i>
                                    <p class="mt-2 small">بدون تصویر</p>
                                </div>
                                {% endif %}
                            </div>
                            <div class="col-md-8">
                                <h4>{{ slider.textSlider }}</h4>
                                {% if slider.altSlide %}
                                <p class="text-muted">{{ slider.altSlide }}</p>
                                {% endif %}

                                <div class="row mt-3">
                                    <div class="col-md-6 mb-2">
                                        <strong>موقعیت:</strong><br>
                                        <span class="badge bg-primary">
                                            <i class="fas fa-home"></i> صفحه اصلی
                                        </span>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>وضعیت:</strong><br>
                                        {% if slider.isActive %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> فعال
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times"></i> غیرفعال
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>تاریخ شروع:</strong><br>
                                        <span class="text-muted">{{ slider.registerData|date:"Y/m/d H:i" }}</span>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>تاریخ پایان:</strong><br>
                                        <span class="text-muted">{{ slider.endData|date:"Y/m/d H:i" }}</span>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>تاریخ ایجاد:</strong><br>
                                        <span class="text-muted">{{ slider.createdAt|date:"Y/m/d" }}</span>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <strong>شناسه:</strong><br>
                                        <code>#{{ slider.id }}</code>
                                    </div>
                                </div>

                                {% if slider.link %}
                                <div class="mt-3">
                                    <strong>لینک:</strong><br>
                                    <a href="{{ slider.link }}" target="_blank" class="text-break small">
                                        {{ slider.link|truncatechars:50 }}
                                    </a>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- وضعیت زمانی -->
                <div class="card mb-4 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-clock"></i> وضعیت زمانی</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="p-3 {% if slider.is_upcoming %}bg-warning{% else %}bg-light{% endif %} rounded">
                                    <div class="h3 mb-1">
                                        {% if slider.is_upcoming %}
                                        <i class="fas fa-hourglass-start text-warning"></i>
                                        {% else %}
                                        <i class="fas fa-check text-muted"></i>
                                        {% endif %}
                                    </div>
                                    <div class="mb-0">شروع نشده</div>
                                    {% if slider.is_upcoming %}
                                    <small class="text-warning">در انتظار شروع</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 {% if not slider.is_upcoming and not slider.is_expired %}bg-success text-white{% else %}bg-light{% endif %} rounded">
                                    <div class="h3 mb-1">
                                        {% if not slider.is_upcoming and not slider.is_expired %}
                                        <i class="fas fa-play"></i>
                                        {% else %}
                                        <i class="fas fa-pause text-muted"></i>
                                        {% endif %}
                                    </div>
                                    <div class="mb-0">در حال اجرا</div>
                                    {% if not slider.is_upcoming and not slider.is_expired %}
                                    <small>هم‌اکنون فعال</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 {% if slider.is_expired %}bg-danger text-white{% else %}bg-light{% endif %} rounded">
                                    <div class="h3 mb-1">
                                        {% if slider.is_expired %}
                                        <i class="fas fa-times"></i>
                                        {% else %}
                                        <i class="fas fa-hourglass-end text-muted"></i>
                                        {% endif %}
                                    </div>
                                    <div class="mb-0">منقضی شده</div>
                                    {% if slider.is_expired %}
                                    <small>پایان یافته</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="progress mt-3" style="height: 25px;">
                            {% if slider.is_upcoming %}
                            <div class="progress-bar bg-warning" style="width: 20%">
                                <i class="fas fa-hourglass-start"></i> شروع نشده
                            </div>
                            <div class="progress-bar bg-light" style="width: 80%">باقی‌مانده</div>
                            {% elif slider.is_expired %}
                            <div class="progress-bar bg-danger" style="width: 100%">
                                <i class="fas fa-times"></i> منقضی شده
                            </div>
                            {% else %}
                            {% with total_days=slider.get_total_days remaining_days=slider.get_remaining_days %}
                            <div class="progress-bar bg-success" style="width: {% widthratio remaining_days total_days 100 %}%">
                                <i class="fas fa-play"></i> در حال اجرا
                            </div>
                            <div class="progress-bar bg-light">
                                باقی‌مانده
                            </div>
                            {% endwith %}
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- تأثیر حذف -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="fas fa-chart-line"></i> تأثیر حذف بر سایت</h6>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle"></i> توجه:</h6>
                            <ul class="mb-0">
                                <li>این اسلایدر در <strong>صفحه اول سایت</strong> نمایش داده می‌شود</li>
                                <li>حذف آن باعث خالی شدن جای اسلایدر در سایت می‌شود</li>
                                <li>اگر این تنها اسلایدر فعال باشد، بخش اسلایدر سایت خالی خواهد شد</li>
                                <li>کاربران ممکن است با صفحه‌ای بدون اسلایدر مواجه شوند</li>
                                <li class="text-danger"><strong>توصیه:</strong> قبل از حذف، یک اسلایدر جدید ایجاد کنید</li>
                            </ul>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="fas fa-images fa-2x text-primary mb-2"></i>
                                    <h6>اسلایدرهای فعال کل</h6>
                                    <h3 class="text-primary">{{ total_active_sliders|default:"0" }}</h3>
                                    <small>پس از حذف: {{ total_active_sliders|add:"-1" }}</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center p-3 bg-light rounded">
                                    <i class="fas fa-play-circle fa-2x text-success mb-2"></i>
                                    <h6>اسلایدرهای در حال اجرا</h6>
                                    <h3 class="text-success">{{ current_sliders|default:"0" }}</h3>
                                    <small>پس از حذف: {{ current_sliders|add:"-1" }}</small>
                                </div>
                            </div>
                        </div>

                        {% if not slider.is_expired and slider.isActive %}
                        <div class="alert alert-danger mt-3">
                            <h6><i class="fas fa-bell"></i> هشدار مهم!</h6>
                            <p class="mb-0">
                                این اسلایدر <strong>فعال</strong> است و <strong>در حال حاضر</strong> در سایت نمایش داده می‌شود.
                                حذف آن باعث حذف فوری از سایت می‌شود.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- فرم حذف -->
                <form method="post" id="deleteForm">
                    {% csrf_token %}
                    <div class="d-flex justify-content-between">
                        <div>
                            <a href="{% url 'panelAdmin:admin_slider_main_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-right"></i> بازگشت به لیست
                            </a>
                            <a href="{% url 'panelAdmin:admin_slider_main_update' slider.id %}" class="btn btn-primary">
                                <i class="fas fa-edit"></i> ویرایش به جای حذف
                            </a>
                        </div>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash"></i> بله، حذف شود
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
.card.border-danger {
    border-width: 3px;
    border-color: #dc3545 !important;
}

.card.border-warning {
    border-width: 2px;
    border-color: #ffc107 !important;
}

.no-image-medium {
    width: 150px;
    height: 150px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 8px;
    margin: 0 auto;
    border: 2px dashed #dee2e6;
}

.progress {
    border-radius: 20px;
    overflow: hidden;
}

.progress-bar {
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-bar i {
    margin-left: 5px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // محاسبه درصد پیشرفت
    function calculateProgress() {
        const startDate = new Date('{{ slider.registerData|date:"c" }}');
        const endDate = new Date('{{ slider.endData|date:"c" }}');
        const now = new Date();

        if (now < startDate) {
            return {percent: 0, status: 'upcoming'};
        } else if (now > endDate) {
            return {percent: 100, status: 'expired'};
        } else {
            const total = endDate - startDate;
            const elapsed = now - startDate;
            const percent = (elapsed / total) * 100;
            return {percent: percent.toFixed(1), status: 'running'};
        }
    }

    const progress = calculateProgress();
    console.log('پیشرفت: ' + progress.percent + '%');
});

// تأیید نهایی حذف
document.getElementById('deleteForm').addEventListener('submit', function(e) {
    let message = '⚠️ هشدار نهایی!\n\n';
    message += 'شما در حال حذف یک اسلایدر اصلی هستید:\n\n';
    message += '• اسلایدر: "{{ slider.textSlider }}"\n';
    message += '• موقعیت: صفحه اصلی سایت\n';
    message += '• شناسه: #{{ slider.id }}\n\n';

    {% if slider.isActive %}
    message += '⚠️ این اسلایدر فعال است و در سایت نمایش داده می‌شود.\n\n';
    {% endif %}

    {% if not slider.is_expired %}
    message += '⚠️ این اسلایدر هنوز منقضی نشده است.\n\n';
    {% endif %}

    message += 'تأثیرات:\n';
    message += '• اسلایدر از صفحه اصلی حذف می‌شود\n';
    message += '• تصویر از سرور حذف می‌شود\n';
    message += '• این عمل غیرقابل بازگشت است\n\n';
    message += 'آیا مطمئن هستید؟';

    if (!confirm(message)) {
        e.preventDefault();
        return false;
    }

    // نمایش پیام در حال حذف
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال حذف...';
    submitBtn.disabled = true;

    // در صورتی که فرم ارسال نشود، دکمه را به حالت اول برگردان
    setTimeout(() => {
        if (!this.wasSubmitted) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }, 3000);

    this.wasSubmitted = true;
    return true;
});

// شمارش معکوس برای تایید
let countdown = 5;
const submitBtn = document.querySelector('#deleteForm button[type="submit"]');
const originalText = submitBtn.innerHTML;
const originalDisabled = submitBtn.disabled;

function updateButton() {
    if (countdown > 0) {
        submitBtn.innerHTML = `(${countdown}) ${originalText}`;
        submitBtn.disabled = true;
        countdown--;
        setTimeout(updateButton, 1000);
    } else {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = originalDisabled;
    }
}

// فعال‌سازی شمارش معکوس
updateButton();
</script>
{% endblock %}