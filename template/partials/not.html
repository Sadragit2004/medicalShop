<script>
    // ============ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù…ÙˆØ¯Ø§Ù„ Ù¾ÛŒØ§Ù… ============
    const MessageModal = {
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
        config: {
            autoClose: true,
            autoCloseTime: 4000,
            animationDuration: 300,
            soundEnabled: true,
            defaultType: 'info',
            icons: {
                success: 'bi-check-circle-fill',
                error: 'bi-x-circle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill',
                question: 'bi-question-circle-fill'
            }
        },

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ
        elements: {},
        isShowing: false,
        currentTimeout: null,
        currentAudio: null,

        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        init() {
            this.elements = {
                modal: document.getElementById('messageModal'),
                title: document.getElementById('messageModalTitle'),
                text: document.getElementById('messageModalText'),
                icon: document.getElementById('messageModalIcon'),
                button: document.querySelector('.modal-button'),
                progressFill: document.querySelector('.progress-fill'),
                sound: document.getElementById('messageModalSound')
            };

            if (!this.elements.modal) {
                console.error('Ø¹Ù†ØµØ± Ù…ÙˆØ¯Ø§Ù„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!');
                return;
            }

            this._setupEventListeners();
            console.log('âœ… MessageModal initialized successfully');
        },

        // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ event listeners
        _setupEventListeners() {
            // Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ backdrop
            this.elements.modal.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-backdrop')) {
                    this.hide();
                }
            });

            // Ø¨Ø³ØªÙ† Ø¨Ø§ Ú©Ù„ÛŒØ¯ ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && this.isShowing) {
                    this.hide();
                }
            });

            // ØªÙˆÙ‚Ù Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø± Ù‡Ù†Ú¯Ø§Ù… hover Ø±ÙˆÛŒ Ù…ÙˆØ¯Ø§Ù„
            this.elements.modal.addEventListener('mouseenter', () => {
                this._pauseAutoClose();
            });

            this.elements.modal.addEventListener('mouseleave', () => {
                this._resumeAutoClose();
            });
        },

        // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¯Ø§Ù„
        show(options = {}) {
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù†Ù…Ø§ÛŒØ´ Ù‡Ù…Ø²Ù…Ø§Ù† Ú†Ù†Ø¯ Ù…ÙˆØ¯Ø§Ù„
            if (this.isShowing) {
                this.hide(() => {
                    setTimeout(() => this._showInternal(options), 100);
                });
                return;
            }

            this._showInternal(options);
        },

        // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø®Ù„ÛŒ
        _showInternal(options) {
            // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            const settings = {
                title: options.title || 'Ù¾ÛŒØ§Ù…',
                message: options.message || '',
                type: options.type || this.config.defaultType,
                autoClose: options.autoClose ?? this.config.autoClose,
                autoCloseTime: options.autoCloseTime || this.config.autoCloseTime,
                icon: options.icon,
                sound: options.sound ?? this.config.soundEnabled,
                onClose: options.onClose,
                className: options.className || ''
            };

            // ØªÙ†Ø¸ÛŒÙ… Ù…ØªÙ† Ùˆ Ø¹Ù†ÙˆØ§Ù†
            this.elements.title.textContent = settings.title;
            this.elements.text.textContent = settings.message;

            // ØªÙ†Ø¸ÛŒÙ… Ù†ÙˆØ¹ Ù…ÙˆØ¯Ø§Ù„
            this._setModalType(settings.type, settings.icon);

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ÛŒ
            if (settings.className) {
                this.elements.modal.className = 'message-modal active ' + settings.className;
            } else {
                this.elements.modal.className = 'message-modal active';
            }

            // Ø­Ø°Ù Ú©Ù„Ø§Ø³ hidden
            this.elements.modal.classList.remove('hidden');

            // Ù¾Ø®Ø´ ØµØ¯Ø§
            if (settings.sound && this.elements.sound) {
                this._playSound();
            }

            // Ø´Ø±ÙˆØ¹ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
            this._startProgressBar(settings.autoCloseTime);

            // ØªÙ†Ø¸ÛŒÙ… flag
            this.isShowing = true;

            // Ø¨Ø³ØªÙ† Ø®ÙˆØ¯Ú©Ø§Ø±
            if (settings.autoClose) {
                this.currentTimeout = setTimeout(() => {
                    this.hide(settings.onClose);
                }, settings.autoCloseTime);
            }

            // dispatch event
            this._dispatchEvent('show', settings);
        },

        // ØªÙ†Ø¸ÛŒÙ… Ù†ÙˆØ¹ Ù…ÙˆØ¯Ø§Ù„
        _setModalType(type, customIcon) {
            // Ø­Ø°Ù Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ù†ÙˆØ¹ Ù‚Ø¨Ù„ÛŒ
            const types = ['success', 'error', 'warning', 'info'];
            types.forEach(t => this.elements.modal.classList.remove(t));

            // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù„Ø§Ø³ Ù†ÙˆØ¹ Ø¬Ø¯ÛŒØ¯
            this.elements.modal.classList.add(type);

            // ØªÙ†Ø¸ÛŒÙ… Ø¢ÛŒÚ©ÙˆÙ†
            const iconClass = customIcon || this.config.icons[type] || this.config.icons.info;
            this.elements.icon.className = 'bi ' + iconClass;
        },

        // Ø´Ø±ÙˆØ¹ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
        _startProgressBar(duration) {
            if (!this.elements.progressFill) return;

            // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø¹Ø±Ø¶
            this.elements.progressFill.style.width = '0%';
            this.elements.progressFill.style.transition = 'none';

            // Ø´Ø±ÙˆØ¹ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø¨Ø§ ØªØ£Ø®ÛŒØ±
            setTimeout(() => {
                this.elements.progressFill.style.transition = `width ${duration}ms linear`;
                this.elements.progressFill.style.width = '100%';
            }, 10);
        },

        // Ù¾Ø®Ø´ ØµØ¯Ø§
        _playSound() {
            if (!this.elements.sound) return;

            try {
                this.elements.sound.currentTime = 0;
                this.elements.sound.play().catch(e => {
                    console.log('ðŸ”‡ Ù¾Ø®Ø´ ØµØ¯Ø§ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯:', e.message);
                });
            } catch (e) {
                console.log('ðŸ”‡ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ ØµØ¯Ø§:', e.message);
            }
        },

        // Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø±
        _pauseAutoClose() {
            if (this.currentTimeout) {
                clearTimeout(this.currentTimeout);
                this.currentTimeout = null;

                // Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
                if (this.elements.progressFill) {
                    const computedStyle = window.getComputedStyle(this.elements.progressFill);
                    const currentWidth = computedStyle.getPropertyValue('width');
                    this.elements.progressFill.style.width = currentWidth;
                    this.elements.progressFill.style.transition = 'none';
                }
            }
        },

        // Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø³ØªÙ‡ Ø´Ø¯Ù† Ø®ÙˆØ¯Ú©Ø§Ø±
        _resumeAutoClose() {
            if (this.config.autoClose && !this.currentTimeout) {
                const remainingTime = this._calculateRemainingTime();

                if (remainingTime > 0) {
                    this.currentTimeout = setTimeout(() => {
                        this.hide();
                    }, remainingTime);

                    // Ø§Ø¯Ø§Ù…Ù‡ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
                    if (this.elements.progressFill) {
                        const currentWidth = parseFloat(this.elements.progressFill.style.width || '0');
                        const remainingWidth = 100 - currentWidth;
                        const duration = (remainingTime * remainingWidth) / 100;

                        this.elements.progressFill.style.transition = `width ${duration}ms linear`;
                        this.elements.progressFill.style.width = '100%';
                    }
                }
            }
        },

        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù…Ø§Ù† Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
        _calculateRemainingTime() {
            if (!this.elements.progressFill) return 0;

            const currentWidth = parseFloat(this.elements.progressFill.style.width || '0');
            const totalTime = this.config.autoCloseTime;

            return totalTime * (100 - currentWidth) / 100;
        },

        // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
        hide(callback) {
            if (!this.isShowing) {
                if (callback) callback();
                return;
            }

            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† timeout
            if (this.currentTimeout) {
                clearTimeout(this.currentTimeout);
                this.currentTimeout = null;
            }

            // Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† ØµØ¯Ø§
            if (this.currentAudio) {
                this.currentAudio.pause();
                this.currentAudio.currentTime = 0;
            }

            // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ù„Ø§Ø³ hiding Ø¨Ø±Ø§ÛŒ Ø§Ù†ÛŒÙ…ÛŒØ´Ù† Ø®Ø±ÙˆØ¬
            this.elements.modal.classList.add('hiding');

            // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø¹Ø¯ Ø§Ø² Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
            setTimeout(() => {
                this.elements.modal.classList.remove('active', 'hiding');
                this.elements.modal.classList.add('hidden');

                // Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† Ø¹Ø±Ø¶ Ù†ÙˆØ§Ø± Ù¾ÛŒØ´Ø±ÙØª
                if (this.elements.progressFill) {
                    this.elements.progressFill.style.width = '0%';
                    this.elements.progressFill.style.transition = 'none';
                }

                this.isShowing = false;

                // Ø§Ø¬Ø±Ø§ÛŒ callback
                if (callback && typeof callback === 'function') {
                    callback();
                }

                // dispatch event
                this._dispatchEvent('hide');
            }, this.config.animationDuration);
        },

        // dispatch custom event
        _dispatchEvent(eventName, detail = {}) {
            const event = new CustomEvent(`messageModal:${eventName}`, {
                detail,
                bubbles: true
            });
            document.dispatchEvent(event);
        },

        // ============ Ù…ØªØ¯Ù‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒ ============

        // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙÙ‚ÛŒØª
        success(message, title = 'Ù…ÙˆÙÙ‚ÛŒØª', options = {}) {
            this.show({
                title,
                message,
                type: 'success',
                ...options
            });
        },

        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§
        error(message, title = 'Ø®Ø·Ø§', options = {}) {
            this.show({
                title,
                message,
                type: 'error',
                ...options
            });
        },

        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø®Ø·Ø§Ø±
        warning(message, title = 'Ø§Ø®Ø·Ø§Ø±', options = {}) {
            this.show({
                title,
                message,
                type: 'warning',
                ...options
            });
        },

        // Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
        info(message, title = 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª', options = {}) {
            this.show({
                title,
                message,
                type: 'info',
                ...options
            });
        },

        // Ù†Ù…Ø§ÛŒØ´ Ø³Ø¤Ø§Ù„
        question(message, title = 'Ø³Ø¤Ø§Ù„', options = {}) {
            this.show({
                title,
                message,
                type: 'info',
                icon: this.config.icons.question,
                autoClose: false,
                ...options
            });
        },

        // Ù†Ù…Ø§ÛŒØ´ Ù„ÙˆØ¯ÛŒÙ†Ú¯
        loading(message = 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...', title = 'Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯') {
            this.show({
                title,
                message,
                type: 'info',
                icon: 'bi-arrow-repeat',
                autoClose: false,
                className: 'loading'
            });
        },

        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ù„ÙˆØ¯ÛŒÙ†Ú¯
        hideLoading() {
            if (this.isShowing && this.elements.modal.classList.contains('loading')) {
                this.hide();
            }
        },

        // ØªØºÛŒÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        setConfig(newConfig) {
            this.config = { ...this.config, ...newConfig };
        },

        // Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ
        getStatus() {
            return {
                isShowing: this.isShowing,
                config: { ...this.config }
            };
        }
    };

    // ============ ØªØ§Ø¨Ø¹â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÛŒØ¹ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¢Ø³Ø§Ù† ============

    // ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ù†Ù…Ø§ÛŒØ´
    function showMessageModal(title, message, type = 'info', options = {}) {
        MessageModal.show({ title, message, type, ...options });
    }

    // ØªÙˆØ§Ø¨Ø¹ Ø³Ø±ÛŒØ¹ Ø¨Ø±Ø§ÛŒ Ø§Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„Ù
    function showSuccess(message, title = 'Ù…ÙˆÙÙ‚ÛŒØª', options = {}) {
        MessageModal.success(message, title, options);
    }

    function showError(message, title = 'Ø®Ø·Ø§', options = {}) {
        MessageModal.error(message, title, options);
    }

    function showWarning(message, title = 'Ø§Ø®Ø·Ø§Ø±', options = {}) {
        MessageModal.warning(message, title, options);
    }

    function showInfo(message, title = 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª', options = {}) {
        MessageModal.info(message, title, options);
    }

    function showQuestion(message, title = 'Ø³Ø¤Ø§Ù„', options = {}) {
        MessageModal.question(message, title, options);
    }

    function showLoading(message = 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...', title = 'Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯') {
        MessageModal.loading(message, title);
    }

    function hideMessageModal() {
        MessageModal.hide();
    }

    function hideLoading() {
        MessageModal.hideLoading();
    }

    // ============ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù‡Ù†Ú¯Ø§Ù… Ù„ÙˆØ¯ ØµÙØ­Ù‡ ============
    document.addEventListener('DOMContentLoaded', function() {
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù…ÙˆØ¯Ø§Ù„
        MessageModal.init();

        // ØªØ³Øª Ø³Ø±ÛŒØ¹ (Ø¯Ø± Ù…Ø­ÛŒØ· ØªÙˆØ³Ø¹Ù‡)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                setTimeout(() => {
                showSuccess('Ù…ÙˆØ¯Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯!', 'Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø±', {
                    autoClose: true,
                    autoCloseTime: 3000
                });
            }, 1000);
        }

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ ØªØ³Øª
        document.addEventListener('messageModal:show', (e) => {
            console.log('ðŸ“¢ Ù…ÙˆØ¯Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯:', e.detail);
        });

        document.addEventListener('messageModal:hide', () => {
            console.log('ðŸ“¢ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø³ØªÙ‡ Ø´Ø¯');
            });
        });

    // ============ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¢Ø¨Ø¬Ú©Øª Ú¯Ù„ÙˆØ¨Ø§Ù„ ============
    window.MessageModal = MessageModal;
    window.showMessageModal = showMessageModal;
    window.showSuccess = showSuccess;
    window.showError = showError;
    window.showWarning = showWarning;
    window.showInfo = showInfo;
    window.showQuestion = showQuestion;
    window.showLoading = showLoading;
    window.hideMessageModal = hideMessageModal;
    window.hideLoading = hideLoading;
    </script>
