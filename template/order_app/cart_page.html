{% extends "main_template.html" %}
{% load static %}
{% load humanize %}

{% block title %}سبد خرید - سایا شاپ{% endblock %}

{% block content %}
<main class="container">
    <!-- Breadcrumb -->
    <nav class="flex mt-8" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
            <li class="inline-flex items-center">
                <a href="{% url 'main:index' %}"
                    class="inline-flex items-center text-sm gap-x-1 text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
                    <svg class="size-4 mb-0.5">
                        <use href="#home" />
                    </svg>
                    صفحه اصلی
                </a>
            </li>
            <li aria-current="page">
                <div class="flex items-center">
                    <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                        xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="m1 9 4-4-4-4" />
                    </svg>
                    <span class="ms-1 text-sm text-gray-500 md:ms-2 dark:text-gray-400">سبد خرید</span>
                </div>
            </li>
        </ol>
    </nav>

    {% if cart_items %}
    <!-- shopping cart -->
    <section class="flex flex-col lg:flex-row justify-between items-start gap-4 child:rounded-lg child:bg-white child:dark:bg-gray-800 child:shadow child:p-4 mt-5">
        <!-- products -->
        <div class="w-full lg:w-3/4 flex flex-col gap-y-8">
            <!-- shopping cart header -->
            <div class="flex items-center justify-between">
                <span class="flex items-center gap-x-2">
                    <h2 class="font-DanaMedium text-xl">سبد خرید</h2>
                    <p class="text-gray-400" id="cart-items-count">({{ cart_count }} کالا)</p>
                </span>
                {% if cart_items %}
                <span class="flex items-center gap-x-1 text-red-600 dark:text-white cursor-pointer" onclick="clearCart()">
                    <p class="mt-1 font-DanaMedium">حذف همه</p>
                    <svg class="w-5 h-5">
                        <use href="#trash"></use>
                    </svg>
                </span>
                {% endif %}
            </div>

            <!-- PRODUCT ITEMS -->
            <div class="w-full flex flex-col gap-y-4 child:p-2 lg:child:p-4">
                {% for item in cart_items %}
                <!-- PRODUCT ITEM -->
                <div class="w-full flex justify-between relative {% if not forloop.last %}border-b-2 border-gray-200 dark:border-white/20{% endif %}">
                    <div class="flex flex-col sm:flex-row items-center gap-6">
                        <!-- IMG AND COUNT BTN -->
                        <div class="flex w-fit flex-col">
                            <img src="{{ item.image }}" class="w-36" alt="{{ item.title }}">
                            <div class="flex items-center justify-between gap-x-1 rounded-lg border border-gray-200 dark:border-white/20 py-1 px-2 mt-2"
                                 data-product-id="{{ item.id }}"
                                 data-detail="{{ item.detail }}"
                                 data-sale-type="{{ item.sale_type }}"
                                 data-min-quantity="{{ item.min_quantity }}"
                                 data-limited-sale="{{ item.limited_sale|default:item.min_quantity }}"
                                 data-member-carton="{{ item.member_carton|default:1 }}"
                                 data-current-quantity="{{ item.quantity }}">
                                <button onclick="changeQuantity(this, -1)"
                                        class="w-4 h-4 decrement text-red-500">
                                    <svg class="w-4 h-4">
                                        <use href="#minus"></use>
                                    </svg>
                                </button>
                                <input type="number" value="{{ item.quantity }}" readonly
                                    class="quantity-input custom-input text-center text-sm bg-transparent w-12">
                                <button onclick="changeQuantity(this, 1)" class="w-4 h-4 increment text-green-600">
                                    <svg class="w-4 h-4">
                                        <use href="#plus"></use>
                                    </svg>
                                </button>
                            </div>
                            {% if item.sale_type == 2 or item.sale_type == 3 %}
                            <p class="text-xs text-amber-600 dark:text-amber-400 mt-1">
                                {% if item.sale_type == 2 %}
                                هر کارتن {{ item.member_carton }} عدد - حداقل {{ item.min_quantity }} کارتن
                                {% else %}
                                حداقل خرید: {{ item.min_quantity }} عدد
                                {% endif %}
                            </p>
                            {% endif %}
                        </div>

                        <!-- information and name product -->
                        <div class="flex flex-col gap-y-4">
                            <div class="flex items-center gap-2">
                                <h2 class="font-DanaMedium line-clamp-1">{{ item.title }}</h2>
                                <!-- Sale Type Badge -->
                                {% if item.sale_type == 1 %}
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full font-DanaMedium">فروش تک</span>
                                {% elif item.sale_type == 2 %}
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full font-DanaMedium">فروش کارتن</span>
                                {% elif item.sale_type == 3 %}
                                <span class="px-2 py-1 bg-amber-100 text-amber-800 text-xs rounded-full font-DanaMedium">فروش محدود</span>
                                {% endif %}
                            </div>
                            <ul class="space-y-3 child:text-sm text-gray-400 child:flex child:items-center child:gap-x-1.5">
                                {% if item.color %}
                                <li>
                                    <span class="size-5 bg-{{ item.color|lower }}-500 rounded-full"></span>
                                    <p>{{ item.color }}</p>
                                </li>
                                {% endif %}
                                {% if item.warranty %}
                                <li>
                                    <svg class="w-5 h-5">
                                        <use href="#shield"></use>
                                    </svg>
                                    <p class="mt-1">{{ item.warranty }}</p>
                                </li>
                                {% endif %}
                                {% if item.sale_type == 2 %}
                                <li>
                                    <svg class="w-5 h-5 text-purple-500">
                                        <use href="#cube"></use>
                                    </svg>
                                    <p class="mt-1">فروش کارتن - هر کارتن {{ item.member_carton }} عدد</p>
                                </li>
                                {% elif item.sale_type == 3 %}
                                <li>
                                    <svg class="w-5 h-5 text-orange-500">
                                        <use href="#exclamation-circle"></use>
                                    </svg>
                                    <p class="mt-1">فروش محدود - حداقل {{ item.min_quantity }} عدد</p>
                                </li>
                                {% endif %}
                                <li>
                                    <svg class="w-5 h-5">
                                        <use href="#truck"></use>
                                    </svg>
                                    <p class="mt-1">ارسال {{ item.shipping_days }} روز کاری</p>
                                </li>
                                {% if item.sale_type == 2 %}
                                <li>
                                    <svg class="w-5 h-5 text-blue-500">
                                        <use href="#squares"></use>
                                    </svg>
                                    <p class="mt-1">هر کارتن {{ item.member_carton }} عددی</p>
                                </li>
                                {% endif %}
                                {% if item.sale_type == 3 %}
                                <li>
                                    <svg class="w-5 h-5 text-amber-500">
                                        <use href="#exclamation-triangle"></use>
                                    </svg>
                                    <p class="mt-1">حداقل خرید {{ item.limited_sale }} عدد</p>
                                </li>
                                {% endif %}
                            </ul>
                            <span class="flex items-center gap-x-1 text-gray-700 dark:text-gray-300 font-DanaMedium mt-4 item-price">
                                <p class="font-DanaMedium text-xl item-price-value">{{ item.price|intcomma }}</p>
                                <p class="text-lg">تومان</p>
                            </span>
                            <span class="absolute bottom-3 left-0 text-blue-500 flex sm:hidden items-center gap-x-1 text-sm cursor-pointer">
                                <p class="hidden sm:flex">افزودن به خرید بعدی</p>
                                <p class="flex sm:hidden">خرید بعدی</p>
                                <svg class="w-4 h-4">
                                    <use href="#chevron-left"></use>
                                </svg>
                            </span>
                            <button onclick="removeFromCart('{{ item.id }}', '{{ item.detail }}')" class="flex sm:hidden absolute top-0 left-0 w-5 h-5 text-red-500 hover:text-red-600">
                                <svg class="w-5 h-5">
                                    <use href="#close"></use>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="hidden sm:flex items-end justify-between flex-col">
                        <button onclick="removeFromCart('{{ item.id }}', '{{ item.detail }}')" class="w-5 h-5 cursor-pointer text-red-500 hover:text-red-600">
                            <svg class="w-5 h-5">
                                <use href="#x-mark"></use>
                            </svg>
                        </button>
                        <span class="absolute bottom-5 text-blue-500 hover:ml-2 duration-300 transition-all flex items-center gap-x-1 text-sm cursor-pointer">
                            <p class="hidden md:flex">افزودن به خرید بعدی</p>
                            <p class="flex md:hidden">خرید بعدی</p>
                            <svg class="w-4 h-4">
                                <use href="#chevron-left"></use>
                            </svg>
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- PRICE BOX -->
        <div class="w-full lg:w-1/4 lg:sticky top-5 flex flex-col gap-y-4">
            <!-- PRICE -->
            <ul class="child:flex child:items-center child:justify-between space-y-8">
                <li>
                    <p>قیمت کالاها (<span id="cart-count-display">{{ cart_count }}</span>)</p>
                    <p class="flex gap-x-1 text-gray-600 dark:text-gray-300" id="products-price">{{ total_price|intcomma }} <span class="hidden xl:flex">تومان</span></p>
                </li>
                <li>
                    <p>هزینه ارسال</p>
                    <p class="font-DanaMedium text-green-600 dark:text-green-400">رایگان</p>
                </li>
                <li class="border-t-2 border-dashed border-gray-400 pt-8">
                    <p>مجموع سبد خرید:</p>
                    <p class="font-DanaMedium text-xl text-gray-900 dark:text-white" id="total-price">{{ total_price|intcomma }} تومان</p>
                </li>
            </ul>

            {% if cart_items %}
            <a href="{% url 'order:createOrder' %}"
                class="w-full mt-4 flex items-center gap-x-1 justify-center bg-blue-500 text-white hover:bg-blue-600 transition-all rounded-lg shadow py-3">
                تایید و تکمیل سفارش
                <svg class="w-5 h-5">
                    <use href="#shopping-bag"></use>
                </svg>
            </a>
            {% endif %}

            <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                <p class="text-sm text-blue-800 dark:text-blue-200 text-center">
                    ارسال رایگان برای خریدهای بالای ۵۰۰ هزار تومان
                </p>
            </div>
        </div>
    </section>
    {% else %}
    <!-- Empty Cart -->
    <section class="flex flex-col items-center justify-center py-16 text-center">
        <svg class="w-24 h-24 text-gray-300 dark:text-gray-600 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-2.5 5M7 13l2.5 5M7 13l-2.5-2.5M17 13v6a2 2 0 01-2 2H9a2 2 0 01-2-2v-6m10 0V9a2 2 0 00-2-2H9a2 2 0 00-2 2v4.01"></path>
        </svg>
        <h2 class="text-2xl font-DanaMedium text-gray-900 dark:text-white mb-2">سبد خرید شما خالی است</h2>
        <p class="text-gray-500 dark:text-gray-400 mb-6">محصولی در سبد خرید شما وجود ندارد</p>
        <a href="{% url 'main:index' %}" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors">
            بازگشت به فروشگاه
        </a>
    </section>
    {% endif %}
</main>

<script>
// ========================
// متغیرهای سراسری
// ========================
let isUpdating = false;

// ========================
// توابع اصلی
// ========================

function changeQuantity(button, change) {
    if (isUpdating) return;

    const container = button.closest('[data-product-id]');
    const productId = container.getAttribute('data-product-id');
    const detail = container.getAttribute('data-detail');
    const saleType = parseInt(container.getAttribute('data-sale-type'));
    const minQuantity = parseInt(container.getAttribute('data-min-quantity')) || 1;
    const limitedSale = parseInt(container.getAttribute('data-limited-sale')) || minQuantity;
    const memberCarton = parseInt(container.getAttribute('data-member-carton')) || 1;
    const quantityInput = container.querySelector('.quantity-input');
    const currentQuantity = parseInt(quantityInput.value) || minQuantity;

    let newQuantity = currentQuantity + change;

    // بررسی محدودیت‌ها بر اساس نوع فروش
    if (saleType === 1) { // فروش تک
        if (newQuantity < 1) {
            showNotification('حداقل خرید ۱ عدد است', 'error');
            return;
        }
    } else if (saleType === 2) { // فروش کارتن
        if (change < 0 && newQuantity < minQuantity) {
            showNotification(`حداقل خرید ${minQuantity} کارتن است`, 'error');
            return;
        }
        // برای کارتن، حداقل باید minQuantity باشد
        if (change > 0 && newQuantity < minQuantity) {
            newQuantity = minQuantity;
        }
    } else if (saleType === 3) { // فروش محدود
        if (change < 0 && newQuantity < limitedSale) {
            showNotification(`حداقل خرید ${limitedSale} عدد است`, 'error');
            return;
        }
        // برای فروش محدود، هنگام افزایش باید مستقیماً به limitedSale برود
        if (change > 0 && newQuantity < limitedSale) {
            newQuantity = limitedSale;
        }
    }

    // اگر مقدار تغییر نکرده، کاری نکن
    if (newQuantity === currentQuantity) {
        return;
    }

    // آپدیت UI فوری
    quantityInput.value = newQuantity;
    updateButtonStates(container, newQuantity, saleType, minQuantity, limitedSale);

    // ارسال درخواست به سرور
    updateCartItem(productId, newQuantity, detail, container);
}

function updateButtonStates(container, quantity, saleType, minQuantity, limitedSale) {
    const decrementBtn = container.querySelector('.decrement');

    if (decrementBtn) {
        let isDisabled = false;

        if (saleType === 1) {
            isDisabled = quantity <= 1;
        } else if (saleType === 2) {
            isDisabled = quantity <= minQuantity;
        } else if (saleType === 3) {
            isDisabled = quantity <= limitedSale;
        }

        if (isDisabled) {
            decrementBtn.classList.add('opacity-50', 'cursor-not-allowed');
            decrementBtn.disabled = true;
        } else {
            decrementBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            decrementBtn.disabled = false;
        }
    }
}

async function updateCartItem(productId, quantity, detail, container) {
    if (isUpdating) return;
    isUpdating = true;

    // ذخیره مقدار قبلی برای rollback
    const quantityInput = container.querySelector('.quantity-input');
    const previousQuantity = parseInt(quantityInput.value);

    // نمایش حالت لودینگ
    container.style.opacity = '0.7';

    try {
        // دریافت CSRF token
        const csrfToken = getCSRFToken();

        // دریافت sale_type از container
        const saleType = container.getAttribute('data-sale-type') || '1';

        const response = await fetch('/order/cart/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: quantity,
                detail: detail,
                sale_type: saleType
            })
        });

        const data = await response.json();
        console.log('پاسخ سرور:', data);

        if (data.success) {
            // آپدیت تمام UI از داده‌های سرور
            updateAllCartData(data);
            showNotification('سبد خرید بروزرسانی شد', 'success');
        } else {
            // بازگشت به مقدار قبلی
            quantityInput.value = previousQuantity;
            const saleType = parseInt(container.getAttribute('data-sale-type'));
            const minQuantity = parseInt(container.getAttribute('data-min-quantity'));
            const limitedSale = parseInt(container.getAttribute('data-limited-sale'));
            updateButtonStates(container, previousQuantity, saleType, minQuantity, limitedSale);
            showNotification(data.error || 'خطا در بروزرسانی سبد خرید', 'error');
        }
    } catch (error) {
        console.error('خطا در بروزرسانی سبد:', error);
        // بازگشت به مقدار قبلی در صورت خطا
        quantityInput.value = previousQuantity;
        const saleType = parseInt(container.getAttribute('data-sale-type'));
        const minQuantity = parseInt(container.getAttribute('data-min-quantity'));
        const limitedSale = parseInt(container.getAttribute('data-limited-sale'));
        updateButtonStates(container, previousQuantity, saleType, minQuantity, limitedSale);
        showNotification('خطا در ارتباط با سرور', 'error');
    } finally {
        container.style.opacity = '1';
        isUpdating = false;
    }
}

function getCSRFToken() {
    // روش‌های مختلف برای دریافت CSRF token
    const tokenFromMeta = document.querySelector('meta[name="csrf-token"]');
    if (tokenFromMeta) {
        return tokenFromMeta.getAttribute('content');
    }

    const tokenFromCookie = getCookie('csrftoken');
    if (tokenFromCookie) {
        return tokenFromCookie;
    }

    const tokenFromInput = document.querySelector('[name="csrfmiddlewaretoken"]');
    if (tokenFromInput) {
        return tokenFromInput.value;
    }

    console.warn('CSRF token پیدا نشد!');
    return '';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
        }
        }
    }
    return cookieValue;
}

function updateAllCartData(data) {
    // آپدیت تعداد کالاها
    const cartItemsCount = document.getElementById('cart-items-count');
    const cartCountDisplay = document.getElementById('cart-count-display');

    if (cartItemsCount) cartItemsCount.textContent = `(${data.cart_count} کالا)`;
    if (cartCountDisplay) cartCountDisplay.textContent = data.cart_count;

    // آپدیت قیمت محصولات
    const productsPrice = document.getElementById('products-price');
    if (productsPrice) {
        productsPrice.innerHTML = `${data.total_price.toLocaleString()} <span class="hidden xl:flex">تومان</span>`;
    }

    // آپدیت مجموع کل
    const totalPrice = document.getElementById('total-price');
    if (totalPrice) {
        totalPrice.textContent = `${data.total_price.toLocaleString()} تومان`;
        }

    // آپدیت شمارنده هدر
    updateHeaderCartCount(data.cart_count);
}

function updateHeaderCartCount(count) {
    // آپدیت شمارنده دسکتاپ
    const desktopCounter = document.querySelector('.cart-counter span:last-child');
    if (desktopCounter) {
        desktopCounter.textContent = count;
        const counterContainer = desktopCounter.closest('.cart-counter');
        if (counterContainer) {
            counterContainer.style.display = count > 0 ? 'flex' : 'none';
        }
    }

    // آپدیت شمارنده موبایل
    const mobileCounter = document.querySelector('.mobile-cart-counter span:last-child');
    if (mobileCounter) {
        mobileCounter.textContent = count;
        const mobileContainer = mobileCounter.closest('.mobile-cart-counter');
        if (mobileContainer) {
            mobileContainer.style.display = count > 0 ? 'flex' : 'none';
        }
    }
}

function removeFromCart(productId, detail) {
    if (confirm('آیا مطمئن هستید که می‌خواهید این محصول را از سبد خرید حذف کنید؟')) {
        const csrfToken = getCSRFToken();

        fetch('/order/cart/remove/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                product_id: productId,
                detail: detail,
                sale_type: document.querySelector(`[data-product-id="${productId}"][data-detail="${detail}"]`)?.getAttribute('data-sale-type') || 1
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // حذف آیتم از DOM - پیدا کردن آیتم بر اساس productId و detail
                const itemContainer = document.querySelector(`[data-product-id="${productId}"][data-detail="${detail}"]`)?.closest('.relative');
                if (itemContainer) {
                    itemContainer.remove();
                } else {
                    // اگر روش بالا کار نکرد، از روش قدیمی استفاده کنیم
                    const itemElements = document.querySelectorAll('.relative');
                    for (const item of itemElements) {
                        const dataElement = item.querySelector(`[data-product-id="${productId}"][data-detail="${detail}"]`);
                        if (dataElement) {
                            item.remove();
                            break;
                        }
                    }
                }

                // آپدیت داده‌ها
                updateAllCartData(data);

                // بررسی خالی بودن سبد
                    const remainingItems = document.querySelectorAll('.relative');
                    if (remainingItems.length === 0) {
                    location.reload(); // بارگذاری مجدد صفحه
                    }

                showNotification('محصول از سبد خرید حذف شد', 'success');
            } else {
                showNotification(data.error || 'خطا در حذف محصول', 'error');
            }
        })
        .catch(error => {
            console.error('خطا در حذف محصول:', error);
            showNotification('خطا در ارتباط با سرور', 'error');
        });
    }
}

function clearCart() {
    if (confirm('آیا مطمئن هستید که می‌خواهید همه محصولات را از سبد خرید حذف کنید؟')) {
        const csrfToken = getCSRFToken();

        fetch('/order/cart/clear/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // بارگذاری مجدد صفحه
            }
        })
        .catch(error => {
            console.error('خطا در خالی کردن سبد:', error);
            showNotification('خطا در ارتباط با سرور', 'error');
        });
    }
}

// ========================
// سیستم اطلاع‌رسانی
// ========================
function showNotification(message, type = 'success') {
    // حذف نوتیفیکیشن‌های قبلی
    const existingNotifications = document.querySelectorAll('.cart-notification');
    existingNotifications.forEach(notification => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    });

    // ایجاد نوتیفیکیشن جدید
    const notification = document.createElement('div');
    notification.className = `cart-notification fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg font-DanaMedium transition-all duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    notification.style.transform = 'translateX(100%)';
    notification.style.opacity = '0';

    notification.innerHTML = `
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                ${type === 'success'
                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>'
                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>'
                }
            </svg>
            <span>${message}</span>
        </div>
    `;

    document.body.appendChild(notification);

    // انیمیشن ورود
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
        notification.style.opacity = '1';
    }, 10);

    // حذف خودکار بعد ۳ ثانیه
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// ========================
// راه‌اندازی اولیه
// ========================
document.addEventListener('DOMContentLoaded', function() {
    // تنظیم وضعیت اولیه دکمه‌ها برای هر محصول
    const containers = document.querySelectorAll('[data-product-id]');
    containers.forEach(container => {
        const saleType = parseInt(container.getAttribute('data-sale-type')) || 1;
        const minQuantity = parseInt(container.getAttribute('data-min-quantity')) || 1;
        const limitedSale = parseInt(container.getAttribute('data-limited-sale')) || minQuantity;
        const currentQuantity = parseInt(container.querySelector('.quantity-input').value) || minQuantity;

        updateButtonStates(container, currentQuantity, saleType, minQuantity, limitedSale);
    });

    // تست وجود CSRF token
    const csrfToken = getCSRFToken();
    if (!csrfToken) {
        console.error('CSRF token پیدا نشد! درخواست‌ها ممکن است کار نکنند.');
    }
});
</script>

<style>
/* استایل نوتیفیکیشن */
.cart-notification {
    animation: slideIn 0.3s ease-out;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

/* استایل برای دکمه‌های غیرفعال */
.decrement.opacity-50 {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
}

/* استایل لودینگ */
[data-product-id] {
    transition: opacity 0.3s ease;
}
</style>
{% endblock %}