{% extends "main_template.html" %}
{% load humanize %}

{% block content %}

<main class="container">
    <!-- Breadcrumb -->
      <nav class="flex mt-8" aria-label="Breadcrumb">
          <ol class="inline-flex items-center space-x-1 md:space-x-2 rtl:space-x-reverse">
              <li class="inline-flex items-center">
                  <a href="index.html"
                      class="inline-flex items-center text-sm gap-x-1  text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
                      <svg class="size-4 mb-0.5">
                          <use href="#home" />
                      </svg>
                      صفحه اصلی
                  </a>
              </li>
              <li class="inline-flex items-center">
                  <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                  xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="m1 9 4-4-4-4" />
              </svg>
                  <a href="{% url 'order:cart_page' %}"
                      class="inline-flex items-center text-sm gap-x-1  text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
                      سبد خرید
                  </a>
              </li>
              <li aria-current="page">
                  <div class="flex items-center">
                      <svg class="rtl:rotate-180 w-3 h-3 text-gray-400 mx-1" aria-hidden="true"
                          xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 10">
                          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="m1 9 4-4-4-4" />
                      </svg>
                      <span class="ms-1 text-sm  text-gray-500 md:ms-2 dark:text-gray-400">
                          آدرس و زمان ارسال
                      </span>
                  </div>
              </li>
          </ol>
      </nav>

      <!-- پیام‌های سیستمی -->
      {% if messages %}
      <div class="mt-4">
          {% for message in messages %}
          <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-100 text-green-800 border border-green-200 dark:bg-green-900/20 dark:text-green-300 dark:border-green-800{% elif message.tags == 'error' %}bg-red-100 text-red-800 border border-red-200 dark:bg-red-900/20 dark:text-red-300 dark:border-red-800{% else %}bg-blue-100 text-blue-800 border border-blue-200 dark:bg-blue-900/20 dark:text-blue-300 dark:border-blue-800{% endif %}">
              <div class="flex items-center gap-2">
                  <svg class="size-5">
                      <use href="#{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}information-circle{% endif %}"></use>
                  </svg>
                  <span>{{ message }}</span>
              </div>
          </div>
          {% endfor %}
      </div>
      {% endif %}

      <section
          class="flex flex-col lg:flex-row justify-between items-start gap-4 mt-5">
          <!-- Form -->
          <div class="w-full lg:w-3/4 flex flex-col gap-y-4 child:rounded-lg child:bg-white child:dark:bg-gray-800 child:shadow child:p-4">
              <div class="w-full flex flex-col">
              <span class="flex items-center gap-x-2">
                  <a href="{% url 'order:cart_page' %}">
                      <svg class="size-5">
                          <use href="#arrow-right"></use>
                      </svg>
                  </a>
                  <p  class="font-DanaDemiBold text-lg">آدرس و زمان ارسال</p>
              </span>
              <p class="text-gray-500 dark:text-gray-400 font-DanaMedium mt-4 mb-8 text-sm lg:text-base">
                  لطفا اطلاعات خود را به درستی وارد نمایید
              </p>

              <!-- Address Selection Section -->
              <div class="w-full mb-6">
                  <h3 class="font-DanaMedium text-base mb-4">انتخاب آدرس</h3>

                  {% if user_addresses %}
                  <!-- Existing Addresses -->
                  <div class="space-y-3 mb-4">
                      {% for address in user_addresses %}
                      <div class="address-item border border-gray-200 dark:border-gray-600 rounded-lg p-4 cursor-pointer hover:border-blue-500 transition-colors {% if checkout_data.selected_address_id == address.id|stringformat:'s' or forloop.first and not checkout_data.selected_address_id %}ring-2 ring-blue-500 bg-blue-50 dark:bg-blue-900/20{% endif %}"
                           data-address-id="{{ address.id }}">
                          <div class="flex items-start justify-between">
                              <div class="flex items-start gap-3">
                                  <input type="radio" name="selected_address" value="{{ address.id }}"
                                         class="mt-1 text-blue-500 focus:ring-blue-500"
                                         {% if checkout_data.selected_address_id == address.id|stringformat:'s' or forloop.first and not checkout_data.selected_address_id %}checked{% endif %}>
                                  <div>
                                      <p class="font-DanaMedium text-gray-900 dark:text-gray-100">
                                          {{ address.state.name }}، {{ address.city.name }}
                                      </p>
                                      <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
                                          {{ address.addressDetail }}
                                      </p>
                                      {% if address.postalCode %}
                                      <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">
                                          کد پستی: {{ address.postalCode }}
                                      </p>
                                      {% endif %}
                                  </div>
                              </div>
                          </div>
                      </div>
                      {% endfor %}
                  </div>
                  {% else %}
                  <!-- No Address Message -->
                  <div class="text-center py-8 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg mb-4">
                      <svg class="size-12 text-gray-400 mx-auto mb-3">
                          <use href="#location-marker"></use>
                      </svg>
                      <p class="text-gray-500 dark:text-gray-400 font-DanaMedium">شما هنوز آدرسی ثبت نکرده‌اید</p>
                      <p class="text-sm text-gray-400 dark:text-gray-500 mt-1">
                          برای افزودن آدرس جدید به
                          <a href=" " class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300">پروفایل کاربری</a>
                          مراجعه کنید
                      </p>
                  </div>
                  {% endif %}

                  <!-- Add New Address Button -->
                  <button type="button" id="addNewAddressBtn"
                          class="w-full flex flex-col items-center justify-center gap-3 bg-blue-50 dark:bg-blue-900/20 hover:bg-blue-100 dark:hover:bg-blue-900/30 border-2 border-dashed border-blue-300 dark:border-blue-600 rounded-lg py-8 px-6 text-blue-600 dark:text-blue-400 transition-colors"
                          onclick="window.location.href=' '">
                      <svg class="size-8 flex-shrink-0">
                          <use href="#plus"></use>
                      </svg>
                      <span class="font-DanaMedium text-center leading-tight">افزودن آدرس جدید</span>
                  </button>
              </div>

              <!-- Personal Information Form -->
              <div class="flex flex-col lg:flex-row items-start">
                  <form id="checkoutForm" method="post" class="w-full space-y-4" action="{% url 'order:checkout' order.id %}">
                      {% csrf_token %}
                      <input type="hidden" name="selected_address" id="selectedAddressInput" value="{{ checkout_data.selected_address_id }}">

                      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <input type="text" name="first_name" placeholder="نام*"
                             class="block w-full py-1.5 px-3 text-base outline dark:outline-none outline-1 -outline-offset-1 placeholder:text-gray-400 transition-all
                             text-gray-800 dark:text-gray-100 dark:bg-gray-900 bg-slate-100 border border-transparent hover:border-slate-200 appearance-none rounded-md outline-none focus:bg-white focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 dark:focus:ring-blue-400 h-11"
                             value="{{ checkout_data.first_name|default:request.user.name }}" required>
                          <input type="text" name="last_name" placeholder="نام خانوادگی*"
                             class="block w-full py-1.5 px-3 text-base outline dark:outline-none outline-1 -outline-offset-1 placeholder:text-gray-400 transition-all
                             text-gray-800 dark:text-gray-100 dark:bg-gray-900 bg-slate-100 border border-transparent hover:border-slate-200 appearance-none rounded-md outline-none focus:bg-white focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 dark:focus:ring-blue-400 h-11"
                             value="{{ checkout_data.last_name|default:request.user.family }}" required>
                      </div>

                      <!-- تلفن ثابت -->
                      <div>
                          <input type="tel" name="phone" placeholder="تلفن ثابت با کد شهر*"
                             class="block w-full py-1.5 px-3 text-base outline dark:outline-none outline-1 -outline-offset-1 placeholder:text-gray-400 transition-all
                             text-gray-800 dark:text-gray-100 dark:bg-gray-900 bg-slate-100 border border-transparent hover:border-slate-200 appearance-none rounded-md outline-none focus:bg-white focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 dark:focus:ring-blue-400 h-11"
                             value="{{ checkout_data.phone }}" required>
                          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">مثال: 02112345678</p>
                      </div>

                      <textarea name="description" placeholder="توضیحات سفارش (اختیاری)"
                          class="block w-full py-1.5 px-3 text-base outline dark:outline-none outline-1 -outline-offset-1 placeholder:text-gray-400 transition-all
                          text-gray-800 dark:text-gray-100 dark:bg-gray-900 bg-slate-100 border border-transparent hover:border-slate-200 appearance-none rounded-md outline-none focus:bg-white focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100 dark:focus:ring-blue-400 min-h-[100px]"
                          value="{{ checkout_data.description }}">{{ checkout_data.description }}</textarea>

                      <!-- دکمه‌های فرم -->
                      <div class="flex gap-3 pt-4">
                          <a href="{% url 'order:cart_page' %}" class="flex-1 px-6 py-3 text-center text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-all font-DanaMedium">
                              بازگشت به سبد خرید
                          </a>
                          <button type="submit" name="action" value="save" class="flex-1 px-6 py-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-all font-DanaMedium">
                              ذخیره اطلاعات
                          </button>
                      </div>
                  </form>
              </div>
              </div>

             <div>
                  <h1 class="font-DanaDemiBold text-lg">خلاصه سفارش</h1>
                  <div class="mt-8">
                       <span class="flex items-center gap-x-1.5">
                      <svg class="size-6 text-blue-500 mb-1">
                          <use href="#truck"></use>
                      </svg>
                      <h1 class="font-DanaMedium text-lg">سفارش شما</h1>
                      </span>
                      <div class="space-y-4 mt-4">
                          {% for item in order_items %}
                          <div class="flex items-start gap-3 p-3 border border-gray-200 dark:border-gray-600 rounded-lg">
                              <img src="{{ item.product.mainImage.url }}" class="w-20 h-20 object-cover rounded" alt="{{ item.product.title }}">
                              <div class="flex-1">
                                  <h3 class="font-DanaMedium text-gray-900 dark:text-gray-100">{{ item.product.title }}</h3>
                                  {% if item.selectedOptions %}
                                  <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">{{ item.selectedOptions }}</p>
                                  {% endif %}
                                  <div class="flex items-center justify-between mt-2">
                                      <span class="text-gray-600 dark:text-gray-400">تعداد: {{ item.qty }}</span>
                                      <span class="font-DanaMedium text-gray-900 dark:text-gray-100">{{ item.price|intcomma }} تومان</span>
                                  </div>
                              </div>
                          </div>
                          {% empty %}
                          <div class="text-center py-8">
                              <svg class="size-12 text-gray-400 mx-auto mb-3">
                                  <use href="#shopping-cart"></use>
                              </svg>
                              <p class="text-gray-500 dark:text-gray-400">محصولی در سبد خرید وجود ندارد</p>
                          </div>
                          {% endfor %}
                      </div>
                  </div>
              </div>
          </div>
          <!-- PRICE BOX -->
          <div class="w-full lg:w-1/4 lg:sticky top-5 flex flex-col gap-y-4 rounded-lg bg-white dark:bg-gray-800 shadow p-4">
              <!-- PRICE -->
              <ul class="child:flex child:items-center child:justify-between space-y-8">
                  <li>
                      <p>قیمت کالاها({{ order_items.count }})</p>
                      <p class="flex gap-x-1 text-gray-600 dark:text-gray-300">{{ subtotal|intcomma }} <span class="hidden xl:flex">تومان</span></p>
                  </li>
                  {% if discount_amount > 0 %}
                  <li class="text-red-500 dark:text-red-400">
                      <p>تخفیف ({{ discount_percent }}%)</p>
                      <p class="font-DanaMedium">-{{ discount_amount|intcomma }} تومان</p>
                  </li>
                  {% endif %}
                  <li class="border-t-2 border-dashed border-gray-400 pt-8">
                      <p class="font-DanaMedium">مبلغ نهایی:</p>
                      <p class="font-DanaDemiBold text-xl text-blue-600 dark:text-blue-400">{{ final_total|intcomma }} تومان</p>
                  </li>
              </ul>

              <!-- دکمه پرداخت نهایی -->
              <form method="post" action="{% url 'order:checkout' order.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="selected_address" value="{{ checkout_data.selected_address_id }}">
                  <input type="hidden" name="first_name" value="{{ checkout_data.first_name|default:request.user.name }}">
                  <input type="hidden" name="last_name" value="{{ checkout_data.last_name|default:request.user.family }}">
                  <input type="hidden" name="phone" value="{{ checkout_data.phone }}">
                  <input type="hidden" name="description" value="{{ checkout_data.description }}">

                  <button type="submit" name="action" value="pay"
                          class="w-full mt-4 flex items-center gap-x-1 justify-center bg-green-500 hover:bg-green-600 text-white transition-all rounded-lg shadow py-3 font-DanaDemiBold disabled:opacity-50 disabled:cursor-not-allowed"
                          {% if not checkout_data.selected_address_id %}disabled{% endif %}>
                      <svg class="w-5 h-5">
                          <use href="#shopping-bag"></use>
                      </svg>
                      تایید و پرداخت نهایی
                  </button>
              </form>

              <!-- شرایط و قوانین -->
              <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                  <div class="flex items-start gap-2">
                      <svg class="size-4 text-gray-400 mt-0.5 flex-shrink-0">
                          <use href="#information-circle"></use>
                      </svg>
                      <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed">
                          با کلیک بر روی دکمه پرداخت، موافقت خود را با
                          <a href=" " class="text-blue-500 hover:text-blue-600 dark:text-blue-400 dark:hover:text-blue-300">قوانین و مقررات</a>
                          فروشگاه اعلام می‌کنید.
                      </p>
                  </div>
              </div>
          </div>
      </section>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
      // Address selection
      document.querySelectorAll('.address-item').forEach(item => {
          item.addEventListener('click', function() {
              // Uncheck all radio buttons
              document.querySelectorAll('.address-item input[type="radio"]').forEach(radio => {
                  radio.checked = false;
              });

              // Remove selection style from all items
              document.querySelectorAll('.address-item').forEach(i => {
                  i.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');
              });

              // Check this item's radio button
              const radio = this.querySelector('input[type="radio"]');
              if (radio) {
                  radio.checked = true;

                  // Add selection style
                  this.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50', 'dark:bg-blue-900/20');

                  // Update hidden input
                  document.getElementById('selectedAddressInput').value = radio.value;

                  // Enable/disable pay button
                  updatePayButtonState();
              }
          });
      });

      // Phone input formatting
      const phoneInput = document.querySelector('input[name="phone"]');
      if (phoneInput) {
          phoneInput.addEventListener('input', function(e) {
              // Remove non-numeric characters
              this.value = this.value.replace(/[^\d]/g, '');
          });
      }

      // Form validation
      const checkoutForm = document.getElementById('checkoutForm');
      if (checkoutForm) {
          checkoutForm.addEventListener('submit', function(e) {
              const firstName = this.querySelector('input[name="first_name"]');
              const lastName = this.querySelector('input[name="last_name"]');
              const phone = this.querySelector('input[name="phone"]');
              const selectedAddress = document.querySelector('input[name="selected_address"]:checked');

              let errors = [];

              if (!firstName.value.trim()) errors.push('نام');
              if (!lastName.value.trim()) errors.push('نام خانوادگی');
              if (!phone.value.trim()) errors.push('تلفن ثابت');
              if (!selectedAddress) errors.push('آدرس');

              if (errors.length > 0) {
                  e.preventDefault();

                  // Show error message
                  const existingError = document.querySelector('.form-error-message');
                  if (existingError) existingError.remove();

                  const errorDiv = document.createElement('div');
                  errorDiv.className = 'form-error-message p-4 mb-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg';
                  errorDiv.innerHTML = `
                      <div class="flex items-center gap-2 text-red-700 dark:text-red-300">
                          <svg class="size-5 flex-shrink-0">
                              <use href="#exclamation-circle"></use>
                          </svg>
                          <div>
                              <p class="font-DanaMedium">لطفاً موارد زیر را تکمیل کنید:</p>
                              <p class="text-sm mt-1">${errors.join('، ')}</p>
                          </div>
                      </div>
                  `;

                  this.insertBefore(errorDiv, this.firstElementChild);

                  // Scroll to error
                  setTimeout(() => {
                      errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  }, 100);

                  // Remove error after 5 seconds
                  setTimeout(() => {
                      if (errorDiv.parentNode) {
                          errorDiv.parentNode.removeChild(errorDiv);
                      }
                  }, 5000);

                  return false;
              }
          });
      }

      // Real-time form validation for pay button
      function updatePayButtonState() {
          const payButton = document.querySelector('button[name="action"][value="pay"]');
          const selectedAddress = document.querySelector('input[name="selected_address"]:checked');

          if (payButton) {
              if (selectedAddress) {
                  payButton.disabled = false;
                  payButton.classList.remove('opacity-50', 'cursor-not-allowed');
              } else {
                  payButton.disabled = true;
                  payButton.classList.add('opacity-50', 'cursor-not-allowed');
              }
          }
      }

      // Initialize pay button state
      updatePayButtonState();

      // Validate phone number format
      function validatePhone(phone) {
          const regex = /^0\d{10}$/;
          return regex.test(phone);
      }

      // Show success message if redirected from save
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('saved')) {
          setTimeout(() => {
              const successMsg = document.createElement('div');
              successMsg.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 z-50 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg';
              successMsg.innerHTML = `
                  <div class="flex items-center gap-2">
                      <svg class="size-5">
                          <use href="#check-circle"></use>
                      </svg>
                      <span>اطلاعات با موفقیت ذخیره شد</span>
                  </div>
              `;
              document.body.appendChild(successMsg);

              setTimeout(() => {
                  successMsg.remove();
              }, 3000);
          }, 500);
      }
  });
  </script>

  <style>
  /* Custom styles for checkout page */
  .address-item {
      transition: all 0.2s ease;
  }

  .address-item:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
  }

  .dark .address-item:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .address-item.ring-2 {
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
  }

  /* Form error animation */
  .form-error-message {
      animation: slideDown 0.3s ease-out;
  }

  @keyframes slideDown {
      from {
          opacity: 0;
          transform: translateY(-10px);
      }
      to {
          opacity: 1;
          transform: translateY(0);
      }
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
      .flex-col.lg\:flex-row {
          flex-direction: column;
      }

      .w-full.lg\:w-3\/4,
      .w-full.lg\:w-1\/4 {
          width: 100%;
      }
  }

  /* Focus styles */
  input:focus, textarea:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  /* Button hover effects */
  button:not(:disabled):hover {
      transform: translateY(-1px);
  }

  /* Smooth transitions */
  * {
      transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
      transition-duration: 200ms;
  }
  </style>

{% endblock content %}