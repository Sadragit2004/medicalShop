{% extends "dashboard_template.html" %}
{% load static %}
{% load humanize %}

{% block dashboard_content %}

<div class="grid grid-cols-12 child:col-span-12 mt-5 lg:mt-0 md:child:col-span-4 gap-4 child:rounded-lg child:bg-white child:dark:bg-gray-800 child:w-full child:flex child:shadow child:p-4">
   <div class="flex items-center gap-x-4">
        <svg class="size-9 text-blue-500">
             <use href="#wallet" />
        </svg>
        <div class="flex flex-col gap-y-1">
            <h2 class="font-DanaDemiBold">کیف‌پول</h2>
            <p class="text-gray-500">موجودی : <span>—</span></p>
     </div>
   </div>
   <div class="flex items-center gap-x-4">
        <svg class="size-9 text-blue-500">
             <use href="#shopping-bag" />
        </svg>
        <div class="flex flex-col gap-y-1">
            <h2 class="font-DanaDemiBold">سفارش‌ها</h2>
            <p class="text-gray-500">{{ order_count }} سفارش</p>
     </div>
   </div>
   <div class="flex items-center gap-x-4">
        <svg class="size-9 text-blue-500">
             <use href="#ticket" />
        </svg>
        <div class="flex flex-col gap-y-1">
            <h2 class="font-DanaDemiBold">تیکت‌ها</h2>
            <p class="text-gray-500">—</p>
     </div>
   </div>
</div>

<div class="flex flex-col shadow rounded-lg p-4 dark:bg-gray-800 bg-white mt-5">
    <span class="flex items-center gap-x-2">
        <img src="{% static 'images/svg/status-delivered.svg' %}" class="w-10" alt="">
        <h2 class="font-DanaMedium text-lg">سفارش های اخیر :</h2>
    </span>
    <div class="relative mt-5 overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
        <table class="w-full text-sm text-right text-gray-500 dark:text-gray-400">
            <thead class="text-xs text-gray-700  bg-gray-100 dark:bg-gray-900 dark:text-gray-200">
                  <tr>
                        <th scope="col" class="px-6 py-3.5">
                                کد سفارش
                        </th>
                         <th scope="col" class="px-6 py-3.5">
                                تاریخ
                        </th>
                        <th scope="col" class="px-6 py-3.5">
                                مبلغ
                        </th>
                        <th scope="col" class="px-6 py-3.5">
                                وضعیت
                        </th>
                        <th scope="col" class="px-6 py-3.5 text-center">
                                جزئیات
                        </th>
                  </tr>
            </thead>
                <tbody>
                    {% for order in recent_orders %}
                    <tr class="bg-white border-b cursor-pointer dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all">
                        <th scope="row"
                            class="px-6 py-5 font-medium text-gray-900 whitespace-nowrap dark:text-white flex items-center gap-x-2">
                               {{ order.orderCode }}
                        </th>
                        <td class="px-6 py-5">
                            {{ order.registerDate|date:"Y/m/d" }}
                        </td>
                        <td class="px-6 py-5">
                            {{ order.get_order_total_price|default:0|intcomma }} تومان
                        </td>
                        <td class="px-6 py-5">
                            {% if order.status == "delivered" %}
                                <span class="text-green-500 font-DanaDemiBold">تحویل داده شده</span>
                            {% elif order.status == "shipped" %}
                                <span class="text-blue-500 font-DanaDemiBold">ارسال شده</span>
                            {% elif order.status == "paid" %}
                                <span class="text-blue-500 font-DanaDemiBold">پرداخت شده </span>
                            {% elif order.status == "processing" %}
                                <span class="text-amber-500 font-DanaDemiBold">در حال پردازش</span>
                            {% elif order.status == "pending" %}
                                <span class="text-yellow-500 font-DanaDemiBold">در انتظار</span>
                            {% else %}
                                <span class="text-red-500 font-DanaDemiBold">لغو شده</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-5 text-center">
                            <button
                              class="view-order-details px-3 py-1 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 border border-blue-200 dark:border-blue-500 rounded-md text-xs font-DanaMedium transition-all"
                              data-target="order-details-{{ order.id }}">
                              مشاهده
                            </button>
                        </td>
                    </tr>
                    <template id="order-details-{{ order.id }}">
                        <div class="space-y-3">
                            {% for item in order.details.all %}
                            <div class="flex items-start gap-3 p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                                <img src="{{ item.product.mainImage.url }}" class="w-16 h-16 object-cover rounded" alt="{{ item.product.title }}">
                                <div class="flex-1 space-y-1">
                                    <p class="font-DanaMedium text-gray-900 dark:text-gray-100">{{ item.product.title }}</p>
                                    {% if item.selectedOptions %}
                                    <p class="text-xs text-gray-500 dark:text-gray-400">{{ item.selectedOptions }}</p>
                                    {% endif %}
                                    <p class="text-sm text-gray-600 dark:text-gray-300">تعداد: {{ item.qty }}</p>
                                    <p class="text-sm text-gray-800 dark:text-gray-100 font-DanaMedium">
                                        مبلغ: {{ item.price|intcomma }} تومان
                                    </p>
                                </div>
                            </div>
                            {% empty %}
                            <p class="text-center text-gray-500 dark:text-gray-400">آیتمی ثبت نشده است</p>
                            {% endfor %}
                        </div>
                    </template>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-5 text-center text-gray-500 dark:text-gray-300">سفارشی ثبت نشده است</td>
                    </tr>
                    {% endfor %}
                </tbody>
        </table>
    </div>
   </div>
   <div class="w-full flex flex-col shadow rounded-lg p-4 dark:bg-gray-800 bg-white mt-5 mb-8">
     <div class="flex items-center justify-between">
     <span class="flex items-center gap-x-2">
        <img src="{% static 'images/svg/map.png' %}" class="w-8" alt="">
        <h2 class="font-DanaMedium text-lg"> آدرس های من:</h2>
    </span>
     <button id="addNewAddressBtn" class="flex items-center gap-x-1 text-blue-500">
            <svg class="size-5  ">
                <use href="#plus"></use>
            </svg>
            <h2 class="font-DanaMedium">آدرس جدید</h2>
        </button>
    </div>
    <ul class="mt-5 space-y-3">
        {% for address in addresses %}
        <li class="w-full border border-blue-300 dark:border-blue-400 p-4 rounded-lg">
            <span class="flex items-center gap-x-1 text-blue-500 dark:text-blue-400">
                <svg class="size-6">
                <use href="#map"></use>
                </svg>
                <h2 class="font-DanaMedium">{{ address.state.name }}، {{ address.city.name }}</h2>
            </span>
            <div class="space-y-1.5 text-gray-600 dark:text-gray-300 mt-3 mr-2">
                <p>{{ address.addressDetail }}</p>
                {% if address.postalCode %}<p>کد پستی: {{ address.postalCode }}</p>{% endif %}
                <p>گیرنده: {{ request.user.name|default:"-" }} | {{ request.user.mobileNumber|default:"-" }}</p>
            </div>
        </li>
        {% empty %}
        <li class="w-full border border-dashed border-blue-300 dark:border-blue-400 p-4 rounded-lg text-center text-gray-500 dark:text-gray-300">
            هیچ آدرسی ثبت نشده است.
        </li>
        {% endfor %}
    </ul>
   </div>

<!-- Address Modal -->
<div id="addressModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-DanaDemiBold text-gray-900 dark:text-gray-100">افزودن آدرس جدید</h3>
            <button id="closeModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                <svg class="size-6">
                    <use href="#x-mark"></use>
                </svg>
            </button>
        </div>

        <form id="addressForm" class="p-6 space-y-4">
            {% csrf_token %}
            <div>
                <label class="block text-sm font-DanaMedium text-gray-700 dark:text-gray-300 mb-2">استان *</label>
                <select id="stateSelect" class="w-full py-2.5 px-3 text-base outline-none border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-400">
                    <option value="">انتخاب استان</option>
                    {% for state in states %}
                    <option value="{{ state.id }}">{{ state.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-DanaMedium text-gray-700 dark:text-gray-300 mb-2">شهر *</label>
                <select id="citySelect" class="w-full py-2.5 px-3 text-base outline-none border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-400 disabled:opacity-50" disabled>
                    <option value="">ابتدا استان را انتخاب کنید</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-DanaMedium text-gray-700 dark:text-gray-300 mb-2">آدرس کامل *</label>
                <textarea id="addressDetail" rows="3" placeholder="آدرس دقیق محل سکونت خود را وارد کنید"
                    class="w-full py-2.5 px-3 text-base outline-none border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-400 resize-none"></textarea>
            </div>

            <div>
                <label class="block text-sm font-DanaMedium text-gray-700 dark:text-gray-300 mb-2">کد پستی</label>
                <input type="text" id="postalCode" placeholder="مثال: 1234567890"
                    class="w-full py-2.5 px-3 text-base outline-none border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 dark:focus:ring-blue-400">
            </div>

            <div id="modalError" class="hidden p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-md">
                <div class="flex items-center gap-2 text-red-700 dark:text-red-300">
                    <svg class="size-4 flex-shrink-0">
                        <use href="#exclamation-circle"></use>
                    </svg>
                    <span id="errorText" class="text-sm"></span>
                </div>
            </div>

            <div id="modalSuccess" class="hidden p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-700 rounded-md">
                <div class="flex items-center gap-2 text-green-700 dark:text-green-300">
                    <svg class="size-4 flex-shrink-0">
                        <use href="#check-circle"></use>
                    </svg>
                    <span id="successText" class="text-sm">آدرس با موفقیت اضافه شد</span>
                </div>
            </div>

            <div class="flex gap-3 pt-4">
                <button type="button" id="cancelBtn" class="flex-1 px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-md transition-colors font-DanaMedium">
                    انصراف
                </button>
                <button type="submit" id="submitBtn" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors font-DanaMedium disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="inline-block ml-2" id="submitText">ذخیره آدرس</span>
                    <svg id="submitSpinner" class="inline-block size-4 animate-spin hidden">
                        <use href="#loading"></use>
                    </svg>
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Order details modal (reusable)
    const detailsModal = document.createElement('div');
    detailsModal.id = 'orderDetailsModal';
    detailsModal.className = 'fixed inset-0 z-50 hidden bg-black/50 flex items-center justify-center p-4';
    detailsModal.innerHTML = `
      <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
          <h3 class="text-lg font-DanaDemiBold text-gray-900 dark:text-gray-100">جزئیات سفارش</h3>
          <button id="closeDetailsModal" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
            <svg class="size-6"><use href="#x-mark"></use></svg>
          </button>
        </div>
        <div id="detailsBody" class="p-4 space-y-3"></div>
      </div>
    `;
    document.body.appendChild(detailsModal);

    function openDetails(templateId) {
        const tpl = document.getElementById(templateId);
        const body = document.getElementById('detailsBody');
        if (tpl && body) {
            body.innerHTML = tpl.innerHTML;
            detailsModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
    }
    function closeDetails() {
        detailsModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
    }
    document.getElementById('closeDetailsModal')?.addEventListener('click', closeDetails);
    detailsModal.addEventListener('click', (e) => { if (e.target === detailsModal) closeDetails(); });
    document.querySelectorAll('.view-order-details').forEach(btn => {
        btn.addEventListener('click', () => openDetails(btn.dataset.target));
    });

    // Address modal
    const addressModal = document.getElementById('addressModal');
    const addNewAddressBtn = document.getElementById('addNewAddressBtn');
    const closeModal = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const addressForm = document.getElementById('addressForm');
    const stateSelect = document.getElementById('stateSelect');
    const citySelect = document.getElementById('citySelect');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    const modalError = document.getElementById('modalError');
    const modalSuccess = document.getElementById('modalSuccess');
    const errorText = document.getElementById('errorText');

    function resetForm() {
        addressForm.reset();
        citySelect.innerHTML = '<option value="">ابتدا استان را انتخاب کنید</option>';
        citySelect.disabled = true;
        modalError.classList.add('hidden');
        modalSuccess.classList.add('hidden');
        submitBtn.disabled = false;
        submitText.classList.remove('hidden');
        submitSpinner.classList.add('hidden');
    }

    function closeAddressModal() {
        addressModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
        resetForm();
    }

    addNewAddressBtn && addNewAddressBtn.addEventListener('click', function(e) {
        e.preventDefault();
        addressModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    });

    closeModal && closeModal.addEventListener('click', closeAddressModal);
    cancelBtn && cancelBtn.addEventListener('click', closeAddressModal);

    addressModal && addressModal.addEventListener('click', function(e) {
        if (e.target === addressModal) {
            closeAddressModal();
        }
    });

    stateSelect && stateSelect.addEventListener('change', function() {
        const stateId = this.value;

        if (!stateId) {
            citySelect.innerHTML = '<option value="">ابتدا استان را انتخاب کنید</option>';
            citySelect.disabled = true;
            return;
        }

        citySelect.innerHTML = '<option value="">در حال بارگذاری...</option>';
        citySelect.disabled = true;

        fetch(`/order/api/cities/${stateId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    citySelect.innerHTML = '<option value="">انتخاب شهر</option>';
                    data.cities.forEach(city => {
                        citySelect.innerHTML += `<option value="${city.id}">${city.name}</option>`;
                    });
                    citySelect.disabled = false;
                } else {
                    citySelect.innerHTML = '<option value="">خطا در بارگذاری شهرها</option>';
                    showModalError('خطا در بارگذاری شهرها');
                }
            })
            .catch(error => {
                console.error('Error loading cities:', error);
                citySelect.innerHTML = '<option value="">خطا در بارگذاری شهرها</option>';
                showModalError('خطا در ارتباط با سرور');
            });
    });

    function showModalError(message) {
        errorText.textContent = message;
        modalError.classList.remove('hidden');
        modalSuccess.classList.add('hidden');
    }

    function showModalSuccess() {
        modalSuccess.classList.remove('hidden');
        modalError.classList.add('hidden');
    }

    addressForm && addressForm.addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData();
        formData.append('state', stateSelect.value);
        formData.append('city', citySelect.value);
        formData.append('address_detail', document.getElementById('addressDetail').value.trim());
        formData.append('postal_code', document.getElementById('postalCode').value.trim());

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        formData.append('csrfmiddlewaretoken', csrfToken);

        if (!stateSelect.value || !citySelect.value || !document.getElementById('addressDetail').value.trim()) {
            showModalError('لطفاً تمام فیلدهای ضروری را پر کنید');
            return;
        }

        submitBtn.disabled = true;
        submitText.classList.add('hidden');
        submitSpinner.classList.remove('hidden');
        modalError.classList.add('hidden');

        fetch('/order/api/addresses/create/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showModalSuccess();
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showModalError(data.error || 'خطا در ذخیره آدرس');
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitSpinner.classList.add('hidden');
            }
        })
        .catch(error => {
            console.error('Error creating address:', error);
            showModalError('خطا در ارتباط با سرور');
            submitBtn.disabled = false;
            submitText.classList.remove('hidden');
            submitSpinner.classList.add('hidden');
        });
    });
});
</script>


{% endblock dashboard_content %}