<!-- dashboard/notifications.html -->
{% extends "dashboard_template.html" %}
{% load static %}

{% block dashboard_content %}
<div class="flex flex-col shadow rounded-lg p-4 dark:bg-gray-800 bg-white mt-5 lg:mt-0">
    <div class="flex items-center justify-between">
        <h2 class="font-DanaMedium text-lg">پیام های من:</h2>
        {% if unread_count > 0 %}
        <button onclick="markAllAsRead()" class="text-sm text-blue-500 hover:text-blue-700">
            علامت‌گذاری همه به عنوان خوانده شده
        </button>
        {% endif %}
    </div>

    <div class="mt-5 space-y-3" id="notifications-container">
        {% for notification in notifications %}
        <div class="relative w-full border {% if not notification.is_read %}border-blue-300 dark:border-blue-400{% else %}border-gray-200 dark:border-gray-700{% endif %} p-4 rounded-lg notification-item"
             data-notification-id="{{ notification.id }}">
            <div class="flex items-start justify-between">
                <h2 class="font-DanaMedium text-lg {% if not notification.is_read %}text-blue-500{% else %}text-gray-600 dark:text-gray-400{% endif %}">
                    {{ notification.title }}
                </h2>
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-500">
                        {{ notification.get_time_ago }}
                    </span>
                    {% if not notification.is_read %}
                    <span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
                    {% endif %}
                </div>
            </div>

            <div class="space-y-1.5 text-gray-600 dark:text-gray-300 mt-3 mr-2">
                <p>{{ notification.message }}</p>

                {% if notification.order %}
                <div class="pt-3 flex justify-between items-center">
                    <span class="text-sm text-gray-500">
                        سفارش #{{ notification.order.id }}
                    </span>
                    <a href="{% url 'dashboard:orders' %}" class="p-2 rounded-lg bg-blue-500/10 text-blue-500 hover:bg-blue-500 hover:text-white transition-colors text-sm flex items-center gap-x-1">
                        پیگیری سفارش
                        <svg class="size-4">
                            <use href="#arrow-left"></use>
                        </svg>
                    </a>
                </div>
                {% endif %}
            </div>

            <div class="absolute left-4 bottom-3 flex items-center gap-x-4">
                <button onclick="markAsRead({{ notification.id }})"
                        class="text-green-500 hover:text-green-700 {% if notification.is_read %}opacity-50 cursor-default{% endif %}"
                        {% if notification.is_read %}disabled{% endif %}>
                    <svg class="size-5">
                        <use href="#check"></use>
                    </svg>
                </button>
                <button onclick="deleteNotification({{ notification.id }})" class="text-red-500 hover:text-red-700">
                    <svg class="size-5">
                        <use href="#trash"></use>
                    </svg>
                </button>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-8">
            <svg class="w-16 h-16 mx-auto text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <use href="#bell"></use>
            </svg>
            <p class="mt-4 text-gray-500 dark:text-gray-400">هیچ پیامی ندارید</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// بارگذاری تعداد نوتیفیکیشن‌های خوانده نشده
function loadUnreadCount() {
    fetch('/dashboard/api/notifications/unread-count/')
        .then(response => response.json())
        .then(data => {
            // به روز رسانی دکمه در هدر
            const notificationBadge = document.getElementById('notification-badge');
            if (notificationBadge) {
                if (data.unread_count > 0) {
                    notificationBadge.textContent = data.unread_count;
                    notificationBadge.style.display = 'flex';
                } else {
                    notificationBadge.style.display = 'none';
                }
            }
        });
}

// علامت‌گذاری به عنوان خوانده شده
function markAsRead(notificationId) {
    fetch('/dashboard/api/notifications/mark-read/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({notification_id: notificationId})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const notificationItem = document.querySelector(`.notification-item[data-notification-id="${notificationId}"]`);
            if (notificationItem) {
                notificationItem.querySelector('h2').classList.remove('text-blue-500');
                notificationItem.querySelector('h2').classList.add('text-gray-600', 'dark:text-gray-400');
                notificationItem.classList.remove('border-blue-300', 'dark:border-blue-400');
                notificationItem.classList.add('border-gray-200', 'dark:border-gray-700');

                const readButton = notificationItem.querySelector('button[onclick^="markAsRead"]');
                readButton.classList.add('opacity-50', 'cursor-default');
                readButton.disabled = true;

                const pulseDot = notificationItem.querySelector('.animate-pulse');
                if (pulseDot) {
                    pulseDot.remove();
                }
            }
            loadUnreadCount();
        }
    });
}

// علامت‌گذاری همه به عنوان خوانده شده
function markAllAsRead() {
    fetch('/dashboard/api/notifications/mark-read/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

// حذف نوتیفیکیشن
function deleteNotification(notificationId) {
    if (confirm('آیا از حذف این پیام اطمینان دارید؟')) {
        fetch('/dashboard/api/notifications/delete/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({notification_id: notificationId})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notificationItem = document.querySelector(`.notification-item[data-notification-id="${notificationId}"]`);
                if (notificationItem) {
                    notificationItem.remove();
                }
                loadUnreadCount();
            }
        });
    }
}

// تابع کمکی برای دریافت کوکی CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// بارگذاری اولیه
document.addEventListener('DOMContentLoaded', function() {
    loadUnreadCount();

    // بارگذاری خودکار هر 30 ثانیه
    setInterval(loadUnreadCount, 30000);
});
</script>
{% endblock %}